# 09. Worklog

## Формат записи

Каждая запись:

1. Дата/время.
2. Этап из `06_IMPLEMENTATION_PLAN.md`.
3. Что изменено.
4. Метрики до/после.
5. Визуальный результат.
6. Следующий шаг.

## Записи

### 2026-02-22

1. Создана спецификация `docs/relief/*`.
2. Зафиксирована целевая архитектура:
   - distributed deformation вместо boundary-stroke гор,
   - crust thickness + isostasy,
   - age-depth батиметрия,
   - erosion/sedimentation как обязательный слой,
   - объективные метрики Earth-like качества.
3. Следующий шаг: начать Этап 0 и Этап 1 из `06_IMPLEMENTATION_PLAN.md`.

### 2026-02-22 (реализация орогенеза, этап 0-1)

1. В `rust/planet_engine/src/lib.rs` полностью переработан блок `compute_relief`:
   - добавлены поля распределенной деформации `comp/ext/shear`,
   - добавлена диффузия деформации в широкие коридоры (вместо узкой линии границы),
   - добавлена эволюция толщины коры во времени (`crust` + `crust_eq`),
   - uplift теперь зависит от орогенного драйва и аномалии толщины коры,
   - океанический рельеф в базовой фазе учитывает divergent/convergent сигналы через новые поля.
2. Добавлен второй источник деформации:
   - из сглаженного поля скоростей плит (`velocity_x/velocity_y`) через градиенты дивергенции/сдвига,
   - смешивается с boundary-source и уменьшает эффект "рисованного шва".
3. Снижена зависимость от пост-обработки:
   - `defuse_orogenic_ribbons` применяется только в самом быстром режиме (`erosion_rounds == 0`).
4. Проверки сборки:
   - `bun run wasm:build` — OK,
   - `bun run build` — OK.
5. Контрольные прогоны (detailed):
   - `generations/runs/2026-02-22T22-55-15-317Z_seed-303001`,
   - `generations/runs/2026-02-22T22-55-43-151Z_seed-303002`,
   - `generations/runs/2026-02-22T22-56-11-782Z_seed-303003`.
6. Промежуточный вывод:
   - горный рельеф формируется через более широкие зоны деформации,
   - привязка высот к самой границе плит ослаблена,
   - нужно продолжить этап 2-4 (изостатика/батиметрия/эрозионно-осадочный цикл) для финального качества "как у Земли".

### 2026-02-22 (этап 1, дополнительная стабилизация)

1. Удален неиспользуемый `boundary_scores` из `ComputePlatesResult`.
2. Добавлено сглаженное поле скоростей плит (`velocity_x/velocity_y`) и градиентная деформация:
   - компрессия/экстензия/сдвиг из дивергенции и поперечных производных скорости.
3. Добавлен дополнительный "corridor smoothing" для `comp/ext/shear`, чтобы:
   - убрать гиперлокальные линейные полосы вдоль шва,
   - расширить орогенные зоны до региональных коридоров.
4. Добавлен скрипт оценки качества:
   - `scripts/evaluate-relief-quality.cjs`
   - команда `bun run gen:score`.
5. Контрольные прогоны на актуальном node wasm:
   - `generations/runs/2026-02-22T23-08-43-769Z_seed-616161`,
   - `generations/runs/2026-02-22T23-09-42-618Z_seed-616162`,
   - `generations/runs/2026-02-22T23-10-14-035Z_seed-616163`.
6. Зафиксированные метрики (`gen:score`):
   - `high90BoundaryShare` ~ `0.015..0.035`,
   - `high98BoundaryShare` ~ `0.034..0.074`.

### 2026-02-23 (этап 2, режимы столкновений)

1. В `compute_relief` добавлены явные режимы столкновений по типам плит:
   - `cc_collision` (continent-continent),
   - `oc_collision_cont` (ocean-continent, континентальная сторона),
   - `oc_collision_ocean` (ocean-continent, океаническая сторона),
   - `oo_collision` (ocean-ocean).
2. Добавлены поля:
   - `subduction_source`,
   - `rift_source`.
3. Источник деформации теперь учитывает:
   - относительную кинематику соседних плит,
   - тип пары плит (C-C / O-C / O-O),
   - локальные режимы convergence/divergence/transform.
4. Добавлено сглаживание collision-полей в деформационные коридоры.
5. Обновлены формулы uplift/trench:
   - отдельный вклад для collisional orogen (`orogen_cc`) и arc orogen (`arc_orogen`),
   - trench зависит от `subduction_source` и океанической стороны O-C/O-O,
   - ridge uplift связан с `rift_source`,
   - добавлены `foreland_sag` и `backarc_sag`.
6. Контрольные прогоны:
   - `generations/runs/2026-02-23T02-33-53-443Z_seed-717171`,
   - `generations/runs/2026-02-23T02-34-53-621Z_seed-717172`,
   - `generations/runs/2026-02-23T02-35-25-526Z_seed-717173`.
